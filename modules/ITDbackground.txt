(function() {
    'use strict';

    const STORAGE_KEY = 'full_site_bg';
    const THEME_KEY = 'itd_custom_theme';

    const CSS = `
        body {
            background-attachment: fixed !important;
            background-size: cover !important;
            background-position: center !important;
        }

        #app, .svelte-app-wrapper, .layout, .sidebar-top, .right-sidebar, .feed-tabs {
            background: transparent !important;
            background-color: transparent !important;
            border: none !important;
        }

        .sidebar-logo, .sidebar-avatar-wrapper {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 50% !important;
            transition: background-color 0.2s !important;
            flex-shrink: 0 !important;
        }

        .sidebar-logo {
            width: 72px !important;
            height: 72px !important;
            margin-bottom: 10px !important;
        }

        .sidebar-avatar-wrapper {
            width: 40px !important;
            height: 40px !important;
        }

        body.itd-light .itd-bg-block, 
        body.itd-light .sidebar-logo, 
        body.itd-light .sidebar-avatar-wrapper { 
            background-color: white !important; 
            color: #111 !important; 
        }
        
        body.itd-dark .itd-bg-block, 
        body.itd-dark .sidebar-logo, 
        body.itd-dark .sidebar-avatar-wrapper { 
            background-color: #1a1a1a !important; 
            color: #eee !important; 
            border: 1px solid #333 !important; 
        }

        #bg-settings-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            backdrop-filter: blur(3px); z-index: 999999; display: none;
        }
        #bg-settings-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 20px; border-radius: 16px;
            z-index: 1000000; box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            font-family: sans-serif; width: 240px; display: none;
            flex-direction: column; gap: 10px; color: #000;
        }
        .settings-btn-itd {
            background: #f5f5f5; border: none; padding: 12px; border-radius: 10px;
            cursor: pointer; font-weight: bold; color: #111; text-align: center; font-size: 13px;
        }
        .settings-btn-itd:hover { background: #eeeeee; }
        .danger-itd { color: #ff3b30; }
    `;

    const applyTheme = (theme) => {
        document.body.classList.remove('itd-light', 'itd-dark');
        document.body.classList.add(`itd-${theme}`);
        localStorage.setItem(THEME_KEY, theme);
    };

    const applyBackground = (img) => {
        document.body.style.backgroundImage = img ? `url(${img})` : '';
        img ? localStorage.setItem(STORAGE_KEY, img) : localStorage.removeItem(STORAGE_KEY);
    };

    const styleEl = document.createElement('style');
    styleEl.textContent = CSS;
    document.head.appendChild(styleEl);

    applyBackground(localStorage.getItem(STORAGE_KEY));
    applyTheme(localStorage.getItem(THEME_KEY) || 'light');

    const overlay = document.createElement('div');
    overlay.id = 'bg-settings-overlay';

    const modal = document.createElement('div');
    modal.id = 'bg-settings-modal';
    modal.innerHTML = `
        <div style="font-weight:bold; font-size: 17px; margin-bottom: 5px; text-align: center;">Оформление</div>
        <button class="settings-btn-itd" id="theme-toggle-act">Сменить тему (Светлая/Темная)</button>
        <button class="settings-btn-itd" id="bg-upload-act">Сменить фон</button>
        <button class="settings-btn-itd danger-itd" id="bg-remove-act">Удалить фон</button>
        <button class="settings-btn-itd" id="bg-close-act" style="background: #007aff; color: white;">Закрыть</button>
        <input type="file" id="bg-file-input" style="display:none" accept="image/*">
    `;
    document.body.append(overlay, modal);

    const toggleModal = (show) => {
        modal.style.display = show ? 'flex' : 'none';
        overlay.style.display = show ? 'block' : 'none';
    };

    const tagBlocks = () => {
        const selectors = '.sidebar-pill, main, .post-container, .card, .profile-info, .page-container';
        document.querySelectorAll(selectors).forEach(el => {
            if (!el.classList.contains('itd-bg-block')) {
                el.classList.add('itd-bg-block');
            }
        });
    };

    const injectButton = () => {
        const nav = document.querySelector('.sidebar-nav');
        if (!nav || document.getElementById('bg-settings-trigger')) return;

        const btn = document.createElement('a');
        btn.id = 'bg-settings-trigger';
        btn.className = 'sidebar-nav-item svelte-13vg9xt';
        btn.style.cursor = 'pointer';
        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" width="24" height="24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>`;
        btn.onclick = (e) => { e.preventDefault(); toggleModal(true); };
        nav.appendChild(btn);
    };

    document.getElementById('theme-toggle-act').onclick = () => {
        const current = localStorage.getItem(THEME_KEY) === 'dark' ? 'light' : 'dark';
        applyTheme(current);
    };
    document.getElementById('bg-upload-act').onclick = () => document.getElementById('bg-file-input').click();
    document.getElementById('bg-remove-act').onclick = () => applyBackground(null);
    document.getElementById('bg-close-act').onclick = () => toggleModal(false);
    overlay.onclick = () => toggleModal(false);

    document.getElementById('bg-file-input').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => applyBackground(ev.target.result);
            reader.readAsDataURL(file);
        }
    };

    const observer = new MutationObserver(() => {
        injectButton();
        tagBlocks();
    });
    observer.observe(document.body, { childList: true, subtree: true });

    injectButton();
    tagBlocks();
})();
