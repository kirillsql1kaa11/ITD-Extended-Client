// ==UserScript==
// @name         ITD - приближение на мышку
// @namespace    http://tampermonkey.net/
// @version      1.0
// @author       l1kaa11
// @match        https://xn--d1ah4a.com/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    let targetScale = 1.0;
    let currentScale = 1.0;
    let isAnimating = false;

    const lerp = (start, end, factor) => start + (end - start) * factor;

    const style = document.createElement('style');
    style.innerHTML = `
        .image-viewer__slider, .image-viewer__slide, .image-viewer__content {
            overflow: visible !important;
        }
        .image-viewer__image {
            will-change: transform;
            transform-origin: center center !important;
            z-index: 999999 !important;
            transition: none !important;
        }
    `;
    document.head.appendChild(style);

    function animate() {
        const img = document.querySelector('.image-viewer__image');
        if (!img) {
            isAnimating = false;
            return;
        }

        const smoothness = 0.15;
        currentScale = lerp(currentScale, targetScale, smoothness);
        img.style.transform = `scale(${currentScale})`;

        if (Math.abs(targetScale - currentScale) > 0.001) {
            requestAnimationFrame(animate);
        } else {
            currentScale = targetScale;
            img.style.transform = `scale(${currentScale})`;
            isAnimating = false;
        }
    }

    window.addEventListener('wheel', function(e) {
        const img = document.querySelector('.image-viewer__image');
        if (img) {
            e.preventDefault();
            e.stopImmediatePropagation();

            const zoomSpeed = 0.4;
            if (e.deltaY < 0) {
                targetScale += zoomSpeed;
            } else {
                targetScale = Math.max(1, targetScale - zoomSpeed);
            }

            if (targetScale > 10) targetScale = 10;

            if (!isAnimating) {
                isAnimating = true;
                requestAnimationFrame(animate);
            }
        }
    }, { passive: false, capture: true });

    document.addEventListener('mousedown', (e) => {
        if (!e.target.closest('.image-viewer__image')) {
            targetScale = 1.0;
            currentScale = 1.0;
            const img = document.querySelector('.image-viewer__image');
            if (img) img.style.transform = '';
        }
    });
})();